name: Deploy Angular + PHP via rsync

# O deploy será disparado sempre que houver um push para a branch 'main' (ou 'master')
on:
  push:
    branches:
      # - main # Descomente se sua branch principal for main
      - master # Descomente se sua branch principal for master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

     # Define o caminho base do projeto Angular (para não repetir)
    env:
      ANGULAR_APP_DIR: src/frontend/app
    
    steps:
      # 1. Checkout do código
      - name: 🚚 Get latest code
        uses: actions/checkout@v4

      # 2. Instalar Node.js e Angular CLI
      - name: 🛠️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.21.0' # Use a versão de Node que seu Angular exige
      
      # 3. Instalar dependências (ex: do package.json)
      - name: 📦 Install dependencies
        run: npm ci
        working-directory: ${{ env.ANGULAR_APP_DIR }} # <-- CORREÇÃO: Executa npm ci em src/frontend/app

      # 4. Fazer o Build de Produção do Angular (CORRIGIDO: npx ng build)
      - name: 🏗️ Build Angular App
        # Comando CORRETO: npx executa o binário 'ng' (Angular CLI)
        run: npx ng build --configuration production
        working-directory: ${{ env.ANGULAR_APP_DIR }} # Executa ng build em src/frontend/app
        # O comando 'ng build' irá gerar sua build na pasta 'src/frontend/app/dist/nome-do-seu-projeto'

      # 4.5. Copiar o index.html de redirecionamento para o diretório de build
      - name: 📁 Copy Redirect Index
        run: cp ${{ github.workspace }}/index.html ${{ env.ANGULAR_APP_DIR }}/dist/app/

      # 5. Configurar e Sincronizar com a HostGator via Rsync/SSH
      - name: 🚀 Deploy to HostGator via Rsync
        uses: burnett01/rsync-deployments@7.1.0 # Action popular para rsync
        with:
          # --- Configurações SSH (usando os Secrets) ---
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
          
          # A HostGator Compartilhada geralmente usa a porta 2222
          remote_port: 2222
          
          # --- Configurações Rsync/Deploy ---
          # O caminho LOCAL da sua pasta dist. 
          # O '/' final é crucial para COPIAR O CONTEÚDO (os arquivos .js, .css, index.html)
          # Ajuste 'nome-do-seu-projeto' se for diferente (Ex: 'frontend-app')
          path: ${{ env.ANGULAR_APP_DIR }}/dist/app/
          
          # O caminho REMOTO (public_html/ é a raiz do seu site)
          remote_path: '~/calc.zantech.com.br/' 
          
          # Opções do Rsync: 
          # -avz (archive, verbose, compress) 
          # --delete (Apaga arquivos no destino que não existem mais na origem)
          switches: -avzr --delete